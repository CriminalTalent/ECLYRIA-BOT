# ============================================
# commands/tarot_command.rb (추천 색/장소/물건 포함 - 원본 복원)
# ============================================
class TarotCommand
  COLORS = [
    "에메랄드 그린", "로얄 블루", "아이보리", "스칼렛 레드", "마룬",
    "실버 그레이", "골드", "진한 네이비", "포레스트 그린", "샌드 베이지",
    "오팔 화이트", "라일락", "청동빛 브라운", "스틸 블루", "선셋 오렌지",
    "미스티 핑크", "잿빛 바이올렛", "밤색", "블랙 에보니", "민트 그린",
    "카키", "버건디", "올리브 그린", "파스텔 옐로", "크림 화이트",
    "샤르트뢰즈", "스모키 블루", "클레이 브라운", "라벤더", "스모크 그레이"
  ]
  
  PLACES = [
    "그리핀도르 휴게실 난로 앞",
    "도서관 금서 구역 옆 통로",
    "천문학탑 야간 관측 공간",
    "후플푸프 공용실 파스닙 냄새 나는 구석",
    "슬리데린 지하 통로의 물기 어린 돌기둥 옆",
    "호그스미드 삼선술집 창가 좌석",
    "금지된 숲 가장자리의 낡은 그루터기",
    "변신술 교실 창문 아래",
    "스네이프 교수의 지하 교실 앞",
    "그리핀도르 탑 계단 중간 난간",
    "프리페트 드라이브 그림자진 버스정류장",
    "비밀의 방 상징이 그려진 오래된 벽면",
    "아라곤의 둥지 근처의 거대한 나무뿌리",
    "호그와트 시계탑 안쪽 플랫폼",
    "의무실 창가 커튼 뒤",
    "부엉이 도착장 옆 난간",
    "연회장 상석과 가까운 기둥 뒤",
    "루모스 연습실 한쪽 벽",
    "퀴디치 경기장 서쪽 관람석",
    "마법약 준비실의 오래된 벽난로",
    "그린하우스 3호 옆 작은 의자",
    "흑마법 방어술 교실 뒤편 그림자 구역",
    "비밀 복도 일곱 번째 갑옷 옆",
    "트로피 보관실 유리장 옆",
    "담력 시험 복도",
    "낡은 빗자루 보관소 앞",
    "역사마법 교실 뒤편",
    "기숙사 식당 북쪽 끝 자리",
    "마법부 복도 한쪽 끝 조명 아래",
    "비밀지도에만 보이는 은밀한 통로 입구"
  ]
  
  ITEMS = [
    "시간을 머금은 모래시계",
    "그리핀의 깃털 펜",
    "빛바랜 주문노트",
    "슬리데린 색깔의 비단 리본",
    "작은 수정구",
    "포션 샘플 병",
    "행운의 깃털 장식",
    "은장 초커",
    "호그와트 문양이 새겨진 동전",
    "바람이 머문 깃털 한 올",
    "마법 문양이 새겨진 작은 열쇠",
    "구리빛 단추",
    "달빛을 머금은 유리 조각",
    "낡은 트럼프 한 장",
    "미니 규칙서",
    "부엉이 모양 브로치",
    "작은 책갈피",
    "예언 구슬 파편",
    "앵무새 초록 잉크병",
    "테이프 조각",
    "미니 빗자루 장식",
    "작은 검은 리본",
    "바람의 소리 캡슐",
    "녹슨 체인 조각",
    "은빛 종",
    "유광 단풍잎 모양 조각",
    "작은 편지 봉투",
    "회색빛 부적",
    "고양이 털 한 올",
    "작은 수정별"
  ]

  def initialize(student_id, tarot_data, sheet_manager)
    @student_id    = student_id.to_s.gsub('@', '')
    @tarot_data    = tarot_data
    @sheet_manager = sheet_manager
  end

  def execute
    # (1) 플레이어 확인
    player = @sheet_manager.find_user(@student_id)
    unless player
      return "@#{@student_id} 아직 학적부에 이름이 없네. 먼저 등록부터 하게."
    end

    # (2) 카드 랜덤 1장 뽑기
    card_name, message = @tarot_data.to_a.sample

    # (3) 추천 요소 3종 랜덤 선택
    color = COLORS.sample
    place = PLACES.sample
    item  = ITEMS.sample

    # (4) 사용자 시트 '마지막타로날짜' 갱신
    begin
      today_str = Time.now.getlocal.strftime('%Y-%m-%d')
      @sheet_manager.update_user(@student_id, last_tarot_date: today_str)
    rescue => e
      puts "[TAROT-UPDATE-ERROR] 마지막타로날짜 업데이트 실패: #{e.class} - #{e.message}"
    end

    # (5) 최종 메시지 반환 (멘션 + 추천 포함)
    <<~MSG.strip
      @#{@student_id} 카드를 한 장 뽑았네...

      【 #{card_name} 】

      #{message}

      추천 색: #{color}
      추천 장소: #{place}
      추천 물건: #{item}
    MSG
  end
end
